<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Online Users Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #87CEEB;
      color: #fff;
      font-family: 'Arial Black', Arial, sans-serif;
      overflow: hidden;
    }
    * { box-sizing: border-box; }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 32px;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      height: 100vh;
      position: relative;
      z-index: 1;
      padding: 20px;
    }

    .column {
      flex: 0 1 calc(50% - 16px);
      min-width: 260px;
      text-align: center;
      border: 2px solid #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      background-color: rgba(30, 30, 30, 0.7);
    }
    .column h2 {
      margin-bottom: 20px;
      font-size: 34px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #fff;
    }
    .user-list {
      list-style: none;
      padding: 0;
    }
    .user-list li {
      margin: 15px 0;
      font-size: 28px;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      color: #fff;
      letter-spacing: 1px;
    }
    .user-list li:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    /* –ë–ò–õ–ë–û–†–î */
    .billboard {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 400px;
      height: 300px;
      background: #111;
      border: 6px solid #fff;
      border-radius: 12px;
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 5;
    }
    .billboard h1 {
      font-size: 32px;
      font-weight: bold;
      color: #FFD700;
      text-align: center;
      margin: 15px 0;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
    }
    .billboard img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-top: 3px solid #fff;
    }

    /* Clouds */
    .clouds {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50px;
      opacity: 0.7;
      animation: drift linear infinite;
    }
    @keyframes drift {
      0% { transform: translateX(-100vw); }
      100% { transform: translateX(100vw); }
    }

    /* –®–ê–†–ò–ö–ò */
    .balloon {
      position: absolute;
      bottom: -200px;
      width: 120px;
      height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fly-up linear forwards;
      opacity: 0.85;
    }
    .balloon .bubble {
      width: 100px;
      height: 130px;
      border-radius: 50% 50% 40% 40% / 70% 70% 30% 30%;
      background: red; /* –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transform: rotate(180deg);
    }
    .balloon .string {
      width: 2px;
      height: 50px;
      background: #555;
      margin-top: -5px;
    }
    @keyframes fly-up {
      0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0.85; }
      100% { transform: translateY(-150vh) translateX(-15px) rotate(-2deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div class="clouds"></div>
  <div class="clouds"></div>
  <div class="balloons"></div>
  <div class="billboard">
    <h1>–° –î–Ω–µ–º –†–æ–∂–¥–µ–Ω–∏—è!</h1>
    <img src="https://iili.io/KobqT5F.th.jpg" alt="Birthday">
  </div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const API_BASE_URL = 'https://otp-2-fos4.onrender.com';
    
      const App = () => {
        const [activeChatters, setActiveChatters] = useState([]);
        const [activeModerators, setActiveModerators] = useState([]);
        const [loggedIn, setLoggedIn] = useState(false);
        const [userData, setUserData] = useState(null);
        const [loginValue, setLoginValue] = useState('');
        const [passwordValue, setPasswordValue] = useState('');
        const [isLoggingIn, setIsLoggingIn] = useState(false);
    
        // üéà —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ —à–∞—Ä–∏–∫–∏
        useEffect(() => {
          const colors = ["#FF4500", "#32CD32", "#1E90FF", "#FFD700", "#FF69B4", "#BA55D3"];
          const balloonsContainer = document.querySelector('.balloons');
          let timeout;
    
          const spawnBalloon = () => {
            const balloon = document.createElement('div');
            balloon.className = 'balloon';
            balloon.style.left = `${Math.random() * 90}vw`; 
            balloon.style.animationDuration = `${Math.random() * 10 + 15}s`; 
            const color = colors[Math.floor(Math.random() * colors.length)];
    
            balloon.innerHTML = `
              <div class="bubble" style="background:${color}"></div>
              <div class="string"></div>
            `;
            balloonsContainer.appendChild(balloon);
            setTimeout(() => balloon.remove(), 25000);
    
            const delay = Math.random() * 15000 + 8000;
            timeout = setTimeout(spawnBalloon, delay);
          };
    
          spawnBalloon();
          return () => clearTimeout(timeout);
        }, []);
    
        // ====== –õ–û–ì–ò–ù ======
        const handleLogin = async () => {
          setIsLoggingIn(true);
          try {
            const response = await axios.post(`${API_BASE_URL}/api/login`, {
              login: loginValue,
              password: passwordValue
            });
            const data = response.data;
            if (data.status === 'success' && data.role === 'admin') {
              setUserData(data);
              setLoggedIn(true);
              localStorage.setItem('userData', JSON.stringify(data));
            }
          } catch (e) {
            console.error('Error during login:', e);
          } finally {
            setIsLoggingIn(false);
          }
        };
    
        const handleLogout = () => {
          setLoggedIn(false);
          setUserData(null);
          localStorage.removeItem('userData');
        };
    
        // ====== FETCH ACTIVE USERS ======
        const fetchActiveChatters = async () => {
          if (!userData) return;
          try {
            const response = await axios.get(`${API_BASE_URL}/api/active_operators?direction=–ß–∞—Ç –º–µ–Ω–µ–¥–∂–µ—Ä`, {
              headers: {
                'X-API-Key': userData.apiKey,
                'X-User-Id': userData.id
              }
            });
            const data = response.data;
            if (data.status === 'success') {
              setActiveChatters(data.operators.map(op => ({ 
                ...op, 
                name: op.name.split(" ").slice(0, 2).join(" ") 
              })));
            }
          } catch (e) {
            console.error('Error fetching active operators for –ß–∞—Ç –º–µ–Ω–µ–¥–∂–µ—Ä:', e);
          }
        };
    
        const fetchActiveModerators = async () => {
          if (!userData) return;
          try {
            const response = await axios.get(`${API_BASE_URL}/api/active_operators?direction=–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä`, {
              headers: {
                'X-API-Key': userData.apiKey,
                'X-User-Id': userData.id
              }
            });
            const data = response.data;
            if (data.status === 'success') {
              setActiveModerators(data.operators.map(op => ({ 
                ...op, 
                name: op.name.split(" ").slice(0, 2).join(" ") 
              })));
            }
          } catch (e) {
            console.error('Error fetching active moderators:', e);
          }
        };
    
        // ====== AUTO LOGIN FROM LOCALSTORAGE ======
        useEffect(() => {
          const storedUser = localStorage.getItem('userData');
          if (storedUser) {
            setUserData(JSON.parse(storedUser));
            setLoggedIn(true);
          }
        }, []);
    
        // ====== –ü–ï–†–í–´–ô FETCH ======
        useEffect(() => {
          if (loggedIn) {
            fetchActiveChatters();
            fetchActiveModerators();
          }
        }, [loggedIn]);
    
        // ====== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ò–ô FETCH ======
        useEffect(() => {
          if (loggedIn) {
            const interval = setInterval(() => {
              fetchActiveChatters();
              fetchActiveModerators();
            }, 5000);
            return () => clearInterval(interval);
          }
        }, [loggedIn]);
    
        if (!loggedIn) {
          return (
            <div className="login-container">
              <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
              <input type="text" value={loginValue} onChange={(e) => setLoginValue(e.target.value)} placeholder="–õ–æ–≥–∏–Ω" />
              <input type="password" value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} placeholder="–ü–∞—Ä–æ–ª—å" />
              <button onClick={handleLogin} disabled={isLoggingIn}>
                {isLoggingIn ? <div className="loader"></div> : '–í–æ–π—Ç–∏'}
              </button>
            </div>
          );
        }
    
        return (
          <>
            <div className="user-info">
              <button onClick={handleLogout}>–í—ã–π—Ç–∏</button>
            </div>
    
            <div className="container">
              <div className="column">
                <h2>Online Chatters</h2>
                <ul className="user-list">
                  {activeChatters.map((chatter, index) => (
                    <li key={index}>{chatter.name}</li>
                  ))}
                  {activeChatters.length === 0 && <li>No active chatters</li>}
                </ul>
              </div>
              <div className="column">
                <h2>Online Moderators</h2>
                <ul className="user-list">
                  {activeModerators.map((mod, index) => (
                    <li key={index}>{mod.name}</li>
                  ))}
                  {activeModerators.length === 0 && <li>No active moderators</li>}
                </ul>
              </div>
            </div>
          </>
        );
      };
    
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
